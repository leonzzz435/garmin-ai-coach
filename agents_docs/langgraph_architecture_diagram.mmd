flowchart TD
    %% Input Data Sources
    GC[(Garmin Connect API)]
    UC[User Context Input]
    CD[Competition Data]
    TD[Time/Date Data]

    %% Data Extraction Layer
    TDE[TriathlonCoachDataExtractor]

    %% LangGraph State Management
    TAS[TrainingAnalysisState<br/>- user_id, athlete_name<br/>- garmin_data, contexts<br/>- competitions, dates<br/>- summary fields<br/>- results with reducers]

    %% Analysis Workflow Nodes (2-Stage Architecture)
    subgraph AW ["Analysis Workflow (2-Stage: Summarizers → Experts)"]
        direction TB

        %% Stage 1: Parallel Data Summarization (No Tools)
        subgraph S1 ["Stage 1: Data Summarization"]
            MSN[Metrics Summarizer<br/>Data Extractor<br/>NO tools]
            PSN[Physiology Summarizer<br/>Data Extractor<br/>NO tools]
            ADN[Activity Data<br/>Marcus Chen<br/>NO tools]
        end

        %% Stage 2: Parallel Expert Analysis (With Tools)
        subgraph S2 ["Stage 2: Expert Analysis"]
            MEN[Metrics Expert<br/>Dr. Aiden Nakamura<br/>✓ Plotting ✓ HITL]
            PEN[Physiology Expert<br/>Dr. Kwame Osei<br/>✓ Plotting ✓ HITL]
            AIN[Activity Interpreter<br/>Elena Rodriguez<br/>✓ Plotting ✓ HITL]
        end

        %% Synthesis & Formatting
        SN[Synthesis Node<br/>Maya Lindholm]
        FN[Formatter Node<br/>James Morrison]
        PRN[Plot Resolution Node]
    end

    %% Planning Workflow Nodes
    subgraph PW ["Planning Workflow (Sequential)"]
        direction TB
        SPN[Season Planner Node<br/>Coach Helena]
        DIN[Data Integration Node]
        WPN[Weekly Planner Node<br/>Enhanced Planning]
        PFN[Plan Formatter Node]
    end

    %% Integrated Workflow
    subgraph IW ["Integrated Analysis + Planning"]
        direction TB
        IAW[Analysis Phase<br/>2-Stage: 3 Summarizers + 3 Experts<br/>+ Synthesis + Formatting]
        IPW[Planning Phase<br/>4 Agents Sequential]
    end

    %% Tool Systems
    subgraph TS ["Tool Systems"]
        PT[Plotting Tools<br/>Matplotlib/Plotly]
        PS[PlotStorage<br/>plot_id, metadata<br/>HTML content]
        HT[HITL Tool<br/>ask_human<br/>GraphInterrupt]
        WS[Web Search Tool<br/>Max 3 per analysis]
    end

    %% Cost & Progress Tracking
    subgraph CPT ["Observability & Tracking"]
        LS[LangSmith<br/>Cost Tracking<br/>Trace Monitoring]
        WCT[WorkflowCostTracker<br/>Execution metadata]
        PM[Progress Manager<br/>Real-time updates]
    end

    %% State Management & Storage
    subgraph SMS ["State Management"]
        MS[MemorySaver<br/>Checkpointer]
        SR[State Reducers<br/>plots: x + y<br/>costs: x + y<br/>errors: x + y]
        ES[Execution State<br/>thread_id, config]
    end

    %% Output Generation
    subgraph OG ["Output Generation"]
        AH[Analysis HTML]
        PH[Planning HTML]
        PC[Plot Collection]
        CS[Cost Summary]
        EM[Execution Metadata]
    end

    %% External Systems
    API[Future FastAPI<br/>Mobile Integration]

    %% Main Flow Connections
    GC --> TDE
    UC --> TDE
    CD --> TDE
    TD --> TDE

    TDE --> TAS

    %% Analysis Workflow Flow (2-Stage Architecture)
    %% Stage 1: Parallel Summarization
    TAS --> MSN
    TAS --> PSN
    TAS --> ADN

    %% Stage 2: Summarizers feed Experts
    MSN --> MEN
    PSN --> PEN
    ADN --> AIN

    %% Synthesis combines all expert outputs
    MEN --> SN
    PEN --> SN
    AIN --> SN
    SN --> FN
    FN --> PRN

    %% Planning Workflow Flow
    PRN --> SPN
    SPN --> DIN
    DIN --> WPN
    %% Weekly planner uses the three expert results
    MEN --> WPN
    AIN --> WPN
    PEN --> WPN
    WPN --> PFN

    %% Tool Integration (Only Experts have tools)
    MEN -.-> PT
    MEN -.-> HT
    PEN -.-> PT
    PEN -.-> HT
    AIN -.-> PT
    AIN -.-> HT
    SN -.-> WS
    SPN -.-> HT
    WPN -.-> HT

    PT --> PS
    PS --> PRN
    HT -.-> UC

    %% State Management Integration
    TAS <--> MS
    TAS <--> SR
    TAS <--> ES

    %% Observability Integration
    AW -.-> LS
    PW -.-> LS
    AW -.-> WCT
    PW -.-> WCT
    AW -.-> PM
    PW -.-> PM

    %% Output Generation
    FN --> AH
    PFN --> PH
    PRN --> PC
    WCT --> CS
    WCT --> EM

    %% Final Delivery
    AH -.-> API
    PH -.-> API
    PC -.-> API
    CS -.-> API

    %% Styling
    classDef inputData fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef workflow fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef tools fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef state fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef output fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef external fill:#f1f8e9,stroke:#33691e,stroke-width:2px

    class GC,UC,CD,TD inputData
    class AW,PW,IW,MSN,PSN,ADN,MEN,PEN,AIN,SN,FN,PRN,SPN,DIN,WPN,PFN,S1,S2 workflow
    class TS,PT,PS,WS,HT tools
    class SMS,TAS,MS,SR,ES,CPT,LS,WCT,PM state
    class OG,AH,PH,PC,CS,EM output
    class API external
